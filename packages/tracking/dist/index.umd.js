!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TrackingSDK={})}(this,function(e){"use strict";e.TrackingSDK=class{config;isStarted=!1;observers=new Map;senders={jsonp:()=>Promise.resolve(),image:()=>Promise.resolve(),xhr:()=>Promise.resolve(),fetch:()=>Promise.resolve()};errorStats={jsErrors:0,promiseRejections:0,resourceErrors:0,networkErrors:0,lastErrorTime:null};pendingQueue=[];idleCallbackId=null;_sessionId;constructor(e={}){this.config={endpoint:"https://example.com/track",sender:"jsonp",jsonp:{callbackParam:"callback",timeout:3e3},errorMonitoring:{enabled:!0,captureJSErrors:!0,capturePromiseRejections:!0,captureResourceErrors:!1,captureNetworkErrors:!0,maxErrorsPerSession:50,errorSamplingRate:1,ignoreErrors:[],beforeErrorSend:e=>e},logToPage:!1,fallbackSender:!1,dataProcessor:e=>e,beforeSend:e=>e,afterSend:(e,t)=>{},onError:(e,t)=>{},idleBatchSize:5,...e},this.init()}init(){"undefined"!=typeof window&&(this.setupSenders(),this.setupErrorMonitoring(),console.log("埋点初始化完成"))}setupErrorMonitoring(){this.config.errorMonitoring.enabled&&(this.config.errorMonitoring.captureJSErrors&&window.addEventListener("error",this.handleJSError.bind(this)),this.config.errorMonitoring.capturePromiseRejections&&window.addEventListener("unhandledrejection",this.handlePromiseRejection.bind(this)),this.config.errorMonitoring.captureResourceErrors&&window.addEventListener("error",this.handleResourceError.bind(this),!0),this.log("info","Error monitoring enabled"))}handleJSError(e){if(!this.shouldCaptureError())return;const t={type:"javascript_error",message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno,stack:e.error?.stack,timestamp:Date.now(),url:window.location.href,userAgent:navigator.userAgent};this.isErrorIgnored(t)||(this.errorStats.jsErrors++,this.errorStats.lastErrorTime=Date.now(),this.trackError(t))}handlePromiseRejection(e){if(!this.shouldCaptureError())return;const t={type:"promise_rejection",message:e.reason?.toString()||"Unknown reason",reason:e.reason?.toString()||"Unknown reason",stack:e.reason?.stack,timestamp:Date.now(),url:window.location.href,userAgent:navigator.userAgent};this.isErrorIgnored(t)||(this.errorStats.promiseRejections++,this.errorStats.lastErrorTime=Date.now(),this.trackError(t))}handleResourceError(e){if(!this.shouldCaptureError())return;const t=e.target;if(t&&t!==window&&t.tagName){if(t.hasAttribute("data-tracking-sdk-jsonp"))return void console.log("跳过SDK自身JSONP脚本的资源错误上报");if(t.hasAttribute("data-tracking-sdk-image"))return void console.log("跳过SDK自身图片请求的资源错误上报");const e={type:"resource_error",tagName:t.tagName.toLowerCase(),source:t.src||t.href,message:`Failed to load ${t.tagName.toLowerCase()}`,timestamp:Date.now(),url:window.location.href};if(this.isErrorIgnored(e))return;this.errorStats.resourceErrors++,this.errorStats.lastErrorTime=Date.now(),this.trackError(e)}}shouldCaptureError(){if(Math.random()>this.config.errorMonitoring.errorSamplingRate)return!1;return this.errorStats.jsErrors+this.errorStats.promiseRejections+this.errorStats.resourceErrors<this.config.errorMonitoring.maxErrorsPerSession}isErrorIgnored(e){return this.config.errorMonitoring.ignoreErrors.some(t=>"string"==typeof t?e.message?.includes(t):t instanceof RegExp&&t.test(e.message||""))}trackError(e){const t=this.config.errorMonitoring.beforeErrorSend(e);if(!t)return;const r={...t,category:"error",page:this.getPageInfo(),user:this.getUser(),sessionId:this.getSessionId()};this.sendImmediately(r),this.log("warn","Error tracked:",r)}setupSenders(){this.senders={jsonp:this.createJSONPSender(),image:this.createImageSender(),xhr:this.createXHRSender(),fetch:this.createFetchSender()}}createJSONPSender(){return(e,t)=>new Promise(r=>{const n="tracking_callback_"+Date.now()+"_"+Math.random().toString(36).substr(2),s=document.createElement("script"),o=setTimeout(()=>{i(),this.config.fallbackSender&&this.senders.image(e,t).then(r)},this.config.jsonp.timeout),i=()=>{clearTimeout(o),s.parentNode&&s.parentNode.removeChild(s),delete window[n]};window[n]=e=>{i(),r(e)};const a=new URLSearchParams;a.append("data",JSON.stringify(t)),a.append(this.config.jsonp.callbackParam,n),s.crossOrigin="anonymous",s.src=`${e}?${a.toString()}`,s.setAttribute("data-tracking-sdk-jsonp","true"),s.onerror=()=>{i(),this.config.fallbackSender&&this.senders.image(e,t).then(r)},document.head.appendChild(s)})}createImageSender(){return(e,t)=>new Promise(r=>{const n=new Image,s=setTimeout(()=>{o(),r({success:!0,method:"image",note:"Request sent (timeout)"})},3e3),o=()=>{clearTimeout(s),n.onload=n.onerror=n.onabort=null,n.src=""};n.onload=()=>{o(),r({success:!0,method:"image"})},n.onerror=()=>{o(),r({success:!0,method:"image",note:"Image request completed (data sent)"})},n.onabort=()=>{o(),r({success:!0,method:"image",note:"Request aborted (data sent)"})};const i=new URLSearchParams;i.append("data",encodeURIComponent(JSON.stringify(t))),i.append("t",Date.now().toString()),n.setAttribute("data-tracking-sdk-image","true");try{n.crossOrigin="anonymous",n.src=`${e}?${i.toString()}`}catch{o(),r({success:!0,method:"image",note:"Image src set (may have sent data)"})}})}createXHRSender(){return(e,t)=>new Promise((r,n)=>{const s=new XMLHttpRequest;s.open("POST",e,!0),s.setRequestHeader("Content-Type","application/json"),s.onreadystatechange=()=>{if(4===s.readyState)if(s.status>=200&&s.status<300)try{const e=JSON.parse(s.responseText);r(e)}catch(e){r({success:!0})}else{const e=new Error(`HTTP ${s.status}: ${s.statusText}`);n(e)}},s.onerror=()=>{const e=new Error("Network error");n(e)},s.ontimeout=()=>{const e=new Error("Request timeout");n(e)},s.timeout=1e4,s.send(JSON.stringify(t))})}createFetchSender(){return(e,t)=>fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>{if(!e.ok){throw new Error(`HTTP ${e.status}: ${e.statusText}`)}return e.json().catch(()=>({success:!0}))}).catch(e=>{throw e})}start(){this.isStarted||(this.isStarted=!0,this.setupClickTracking(),this.setupViewTracking(),this.log("info","TrackingSDK started"))}stop(){this.isStarted&&(this.isStarted=!1,this.observers.forEach((e,t)=>{e&&e.disconnect&&e.disconnect()}),this.observers.clear(),this.cancelIdleProcessing(),this.log("info","TrackingSDK stopped"))}setupClickTracking(){document.addEventListener("click",e=>{const t=e.target?.closest("[data-spm]");if(t){"click"===(t.getAttribute("data-track-trigger")||"click")&&this.trackElement(t,e)}},!0)}setupViewTracking(){const e=new MutationObserver(e=>{e.forEach(e=>{"childList"===e.type&&e.addedNodes.forEach(e=>{1===e.nodeType&&(e instanceof Element||e instanceof Document)&&this.scanForViewTrackingElements(e)})})});e.observe(document.body,{childList:!0,subtree:!0}),this.observers.set("mutation",e);const t=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target,r=parseInt(t.getAttribute("data-track-delay")||"0")||0;r>0?setTimeout(()=>{this.isElementVisible(t)&&this.trackElement(t)},r):this.trackElement(t)}})},{threshold:.1,rootMargin:"50px"});this.observers.set("intersection",t),this.scanForViewTrackingElements(document.body)}scanForViewTrackingElements(e){if(e.querySelectorAll('[data-track-trigger="view"]').forEach(e=>{const t=this.observers.get("intersection");t?t.observe(e):console.error("IntersectionObserver未找到")}),e instanceof Element&&e.hasAttribute("data-spm")&&"view"===e.getAttribute("data-track-trigger")){const t=this.observers.get("intersection");t&&t.observe(e)}}isElementVisible(e){const t=e.getBoundingClientRect();return t.top<window.innerHeight&&t.bottom>0}trackElement(e,t=null){if(!e.getAttribute("data-spm"))return;const r=this.buildTrackingData(e,t);this.sendImmediately(r)}getPageInfo(){return{title:document.title,referrer:document.referrer,viewport:{width:window.innerWidth,height:window.innerHeight}}}getUser(){return{userAgent:navigator.userAgent,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone}}getSessionId(){return this._sessionId||(this._sessionId=`session_${Date.now()}_${Math.random().toString(36).substr(2,8)}`),this._sessionId}sendImmediately(e,t={}){if(!e)return;const r=this.config.beforeSend(e);if(!r)return;const n={data:r,timestamp:Date.now(),attempts:0,options:t};this.pendingQueue.push(n),this.log("info","Queued for idle send:",r),this.ensureIdleProcessing()}buildTrackingData(e=null,t=null,r={}){const n={timestamp:Date.now(),url:window.location.href,page:this.getPageInfo(),user:this.getUser(),trigger:"manual",eventData:r,sessionId:this.getSessionId(),category:"default"};if(e){const t=e.getBoundingClientRect();Object.assign(n,{spm:e.getAttribute("data-spm"),trigger:e.getAttribute("data-track-trigger")||"click",position:{x:Math.round(t.left),y:Math.round(t.top),width:Math.round(t.width),height:Math.round(t.height)},element:{tagName:e.tagName.toLowerCase(),className:e.className||"",id:this.getElementTrackingId(e)||"",text:e.textContent?.substring(0,100)||"",attributes:this.getCustomAttributes(e)}})}if(t){const e={type:t.type};"clientX"in t&&"clientY"in t&&(e.clientX=t.clientX,e.clientY=t.clientY),"button"in t&&(e.button=t.button),n.event=e}return this.config.dataProcessor(n)}getCustomAttributes(e){const t={};return Array.from(e.attributes).forEach(e=>{if(e.name.startsWith("data-track-")&&"data-track-trigger"!==e.name&&"data-track-delay"!==e.name){const r=e.name.replace("data-track-","");t[r]=e.value}}),t}sendTrack(e={}){const t=this.buildTrackingData(null,null,e);this.sendImmediately(t)}sendData(e){if(!e||0===e.length)return;const t=this.senders[this.config.sender];if(!t)return void this.log("error","Invalid sender type:",this.config.sender);const r=e.map(e=>e.data),n=Date.now();t(this.config.endpoint,r).then(t=>{this.handleSendSuccess(t,e,Date.now()-n)}).catch(t=>{this.handleSendError(t,e)}).finally(()=>{})}handleSendSuccess(e,t,r){this.log("info",`Sent ${t.length} items successfully in ${r}ms`),t.forEach(t=>{this.config.afterSend(e,t.data),t.options?.onSuccess&&t.options.onSuccess(e)})}handleSendError(e,t){this.log("error","Send failed:",e.message),t.forEach(t=>{this.config.onError(e,t.data),t.options?.onError&&t.options.onError(e)})}updateConfig(e){this.config={...this.config,...e},this.log("info","Updated config:",e)}requestIdleCallback(e){return"undefined"!=typeof window&&"function"==typeof window.requestIdleCallback?window.requestIdleCallback(e,{timeout:1e3}):setTimeout(()=>{e({didTimeout:!0,timeRemaining:()=>50})},0)}cancelIdleCallback(e){null!=e&&("undefined"!=typeof window&&"function"==typeof window.cancelIdleCallback?window.cancelIdleCallback(e):clearTimeout(e))}cancelIdleProcessing(){null!==this.idleCallbackId&&(this.cancelIdleCallback(this.idleCallbackId),this.idleCallbackId=null)}ensureIdleProcessing(){0!==this.pendingQueue.length&&null===this.idleCallbackId&&(this.idleCallbackId=this.requestIdleCallback(e=>{this.idleCallbackId=null,this.processQueueDuringIdle(e)}))}processQueueDuringIdle(e){if(0===this.pendingQueue.length)return;const t=()=>!e||"function"!=typeof e.timeRemaining||(e.timeRemaining()>1||e.didTimeout),r=[];for(;this.pendingQueue.length>0&&t();){const t=Math.min(this.pendingQueue.length,this.getIdleBatchSize()),n=this.pendingQueue.splice(0,t);if(r.push(n),e&&!e.didTimeout&&"function"==typeof e.timeRemaining&&e.timeRemaining()<=1)break}r.forEach(e=>{this.sendData(e)}),this.pendingQueue.length>0&&this.ensureIdleProcessing()}getIdleBatchSize(){const e=this.config.idleBatchSize;return"number"==typeof e&&e>0?Math.max(1,Math.floor(e)):5}log(e,t,...r){if(!this.config.logToPage)return;const n=`[${(new Date).toLocaleTimeString()}] [${e.toUpperCase()}] ${t}`;switch(e){case"error":console.error(n,...r);break;case"warn":console.warn(n,...r);break;case"info":console.info(n,...r);break;default:console.log(n,...r)}}getElementTrackingId(e){const t=e.getAttribute("data-spm-id");if(t)return t;const r=`spm_${e.getAttribute("data-spm")||"unknown"}_${Date.now()}_${Math.random().toString(36).substr(2,6)}`;return e.setAttribute("data-spm-id",r),r}}});
//# sourceMappingURL=index.umd.js.map
